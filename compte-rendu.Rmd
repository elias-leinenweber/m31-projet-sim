---
title: "Simulation du fonctionnement du protocole Aloha discrétisé"
author:
  - Elias Leinenweber
  - Mathieu Zimmermann
output:
  pdf_document:
    number_sections: true
    fig_caption: yes
header-includes:
- |
  ```{=latex}
  \usepackage{algorithm}
  \usepackage{algorithmic}
  ```
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = FALSE, warning = FALSE}
if (!require(ggplot2))
  install.packages("ggplot2", repos = "http://cran.us.r-project.org")
```

# Introduction

L'idée du projet est de simuler le fonctionnement de $n$ stations se partageant
un canal de communication unique, et s'emparant du canal lorsqu'elles souhaitent
l'utiliser, indépendamment l'une de l'autre.

Le temps est discrétisé, découpé en *slots*, et chaque station a une probabilité
$p$ (valeur commune à toutes les stations) de commencer une émission au début
d'un slot. Lorsque deux stations émettent dans le même slot, il y a collision,
et dans ce cas, elles doivent réémettre leur message ultérieurement. Pour
déterminer le moment de la réémission, la station choisit un slot au hasard
uniformément parmi les $k$ slots suivants ($k$ étant un paramètre commun à
l'ensemble des stations partageant le canal).

Un slot est *utile* lorsqu'il permet de transmettre effectivement un message ;
il faut donc qu'il y ait une émission, et une seule, durant le slot. Il n'y a
pas d'abandon de la transmission au bout d'un nombre donné d'échecs.

# Mise en œuvre de la réalisation

\begin{algorithm}
  \caption{Aloha discrétisé}
  \begin{algorithmic}
    \REQUIRE $0 \leq p \leq 1 \land k, n > 0$
    \FOR{$slot = 1$ to $SLOTS$}
      \STATE marquer le slot comme non occupé
      \FOR{$station = 1$ to $n$}
        \IF{le slot est le next slot}
          \STATE ajouter la station aux senders
        \ENDIF
        <!-- TODO Compléter -->
      \ENDFOR
    \ENDFOR
  \end{algorithmic}
\end{algorithm}

# Simulations préliminaires

## Efficacité du système en fonction du nombre de stations

Dans un premier temps, nous allons simuler le fonctionnement du système pour une
durée de $100$ slots, avec $p = 0.01$ et $k = 4$, et évaluer l'efficacité du
système en fonction de $n$ (compris entre $10$ et $100$) : on mesurera le nombre
de slots utiles et le nombre total de messages en attente d'émission à la fin de
la simulation.

```{r message = FALSE, warning = FALSE, figures-side, fig.show = "hold", out.width = "50%"}
res <- read.csv2("res.csv", header = TRUE)
res <- res[res$sim_id == 1,]
res <- res[res$k == 4,]
res <- res[res$n <= 100,]

p1 <- ggplot(data = res, aes(x = n, y = useful_slots)) +
      geom_point(size = 0, alpha = 0.1) +
      geom_smooth() +
      labs(x = "Nombre de stations",
           y = "Nombre de slots utiles",
           title = "Aloha discrétisé (p = 0.01, k = 4, durée : 100)")
print(p1)

p2 <- ggplot(data = res, aes(x = n, y = queued_msgs)) +
      geom_point(size = 0, alpha = 0.1) +
      geom_smooth(color = 'red') +
      labs(x = "Nombre de stations",
           y = "Nombre de messages en attente d'émission",
           title = "")
print(p2)

gb <- ggplot_build(p1)
n_y_max <- gb$data[[2]]$x[which(diff(sign(diff(gb$data[[2]]$y)))== -2 ) + 1]
```

On remarque que l'efficacité du système atteint son pic en
$n \approx r `r round(n_y_max / 5) * 5`$

On peut également définir le concept de *viabilité du réseau*, c'est-à-dire si
le réseau est effectivement utilisable ou non : on constate que pour $p = 0.01$,
$k = 4$, à partir de $n \geq 50$ il est quasiment impossible d'envoyer un
message ; le réseau est définitivement bloqué.

On serait alors tenté de chercher une sorte de "formule magique" qui nous dirait
si le réseau sera saturé à long terme (c'est-à-dire si le nombre moyen de
messages en attente diverge) à partir des paramètres.

## Variation de $k$

Étudions alors l'effet de la variation de $k$ sur l'allure de la courbe.

```{r message = FALSE, fig.align = 'center', out.width = "67%"}
res <- read.csv2("res.csv", header = TRUE)
res <- res[res$sim_id == 1,]
res <- res[res$n <= 100,]

p <- ggplot(data = res, aes(x = n, y = useful_slots, colour = factor(k))) +
     geom_point(size = 0, alpha = 0.1) +
     geom_smooth() +
     labs(x = "Nombre de stations",
          y = "Nombre de slots utiles",
          title = "Aloha discrétisé (p = 0.01, 4 <= k <= 10, durée : 100 slots)")
print(p)
```

On constate que l'augmentation de la valeur de $k$ ne fait que "repousser le
problème" en déportant le nombre de stations optimal vers la droite.

Il nous reste alors à faire varier $p$ et la durée en slots de la simulation.

# Hypothèse

On émet l'hypothèse que la viabilité du réseau, c'est-à-dire si on tend vers une
congestion ou non à long terme, dépend de la valeur de $np$, une estimation
brute de l'espérance du nombre moyen de tentatives d'envoi de message à chaque
slot.

En réalité, il faudrait également prendre en compte le nombre de messages en
attente, ce qui signifie que l'état de chaque slot dépendrait de celui du
précédent. Il aurait donc pu être intéressant d'utiliser un modèle markovien
mais cela dépasse le cadre de ce projet.

# Étude de l'hypothèse

## Différentes valeurs de $np$

```{r figs, message = FALSE, fig.cap="$0.001 < p < 0.005$, $k = 4$, $10 < n < 50$"}
res <- read.csv2("res.csv", header = TRUE)
res <- res[res$sim_id == 2,]
res$queued_msgs <- with(res, queued_msgs * 1.0 / n)

p <- ggplot(data = res, aes(x = slots, y = queued_msgs, colour = factor(np))) +
     geom_smooth() +
     labs(x = "Durée en slots",
          y = "Nombre moyen de messages en attente d'émission",
          color = "n * p",
          title = "Aloha discrétisé")
print(p)
```

## Fixation de $n$ et $p$

<!-- TODO
x : nb de slots passés
y : moyenne des messages en attente
couleur : différentes valeurs de p*n
d'abord fixer n pour un tableau puis fixer p
-->

# Conclusion

<!-- TODO but : trouver un seuil pour n*p -->
En conclusion, le protocole Aloha discrétisé...

# Annexe

Le code source complet de ce projet se trouve à l'adresse suivante :
[`git.unistra.fr/leinenweber/m31-projet-sim`](https://git.unistra.fr/leinenweber/m31-projet-sim).
